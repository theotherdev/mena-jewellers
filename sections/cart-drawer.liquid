{% comment %}
  Cart drawer component that slides in from the right side.
  Displays cart items with ability to update quantities and proceed to checkout.
  Based on Bryan Jimenez cart implementation.
{% endcomment %}

<div id="cart-drawer-overlay" class="fixed inset-0 z-50 flex min-h-screen w-screen justify-end bg-black/20 md:px-[20px]" style="display: none;">

  {%comment%} Desktop Drawer - 1/3 viewport width, visible on md+ {%endcomment%}
  <div class="-mr-[20px] hidden w-1/3 overflow-y-scroll bg-white p-[20px] pr-[40px] md:block">
    <div class="flex justify-between pb-[20px]">
      <p class="text-[12px] font-medium uppercase">{{ 'cart.title' | t }}</p>
      <button id="cart-drawer-close-desktop" class="text-[12px] font-medium md:hidden uppercase">
        {{ 'cart.close' | t | default: 'CLOSE' }}
      </button>
    </div>

    {% if cart.item_count > 0 %}
      <div class="flex flex-col gap-[20px]">
        {% for item in cart.items %}
          <div class="grid grid-cols-3 gap-[10px]">
            <div class="">
              {% render 'image',
                image: item.image,
                width: 200,
                lazy: true
              %}
            </div>

            <div class="col-span-2 flex flex-col justify-between">
              <div class="">
                <p class="text-[12px] font-medium uppercase">{{ item.product.title }}</p>
                {% unless item.variant.title contains 'Default' %}
                  <p class="text-[12px]">Size: {{ item.variant.title }}</p>
                {% endunless %}
                <br>
                <p class="text-[12px]">Quantity: {{ item.quantity }}</p>
                <p class="text-[12px]">Total: {{ item.final_line_price | money }}</p>
              </div>

              <button class="h-min w-min text-[12px]" data-line="{{ forloop.index }}">
                {{ 'cart.remove' | t }}
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <button class="mt-[20px] text-left" id="cart-checkout-desktop">
        <p class="pb-[10px] text-[12px] font-medium">Total: {{ cart.total_price | money }}</p>
        <p class="text-[12px] font-medium">Proceed to Checkout</p>
      </button>
    {% else %}
      <div class="py-[40px] text-center">
        <p class="text-[12px]">{{ 'cart.empty' | t | default: 'Your cart is empty' }}</p>
      </div>
    {% endif %}
  </div>

  {%comment%} Mobile Drawer - Full width, visible on mobile only {%endcomment%}
  <div class="w-full overflow-y-scroll bg-white p-[20px] md:hidden">
    <div class="flex justify-between pb-[20px]">
      <p class="text-[12px] font-medium uppercase">{{ 'cart.title' | t }}</p>
      <button id="cart-drawer-close-mobile" class="text-[12px] font-medium uppercase">
        {{ 'cart.close' | t | default: 'CLOSE' }}
      </button>
    </div>

    {% if cart.item_count > 0 %}
      <div class="flex flex-col gap-[20px]">
        {% for item in cart.items %}
          <div class="grid grid-cols-3 gap-[10px]">
            <div class="">
              {% render 'image',
                image: item.image,
                width: 200,
                lazy: true
              %}
            </div>

            <div class="col-span-2 flex flex-col justify-between">
              <div class="">
                <p class="text-[12px] font-medium uppercase">{{ item.product.title }}</p>
                {% unless item.variant.title contains 'Default' %}
                  <p class="text-[12px]">Size: {{ item.variant.title }}</p>
                {% endunless %}
                <br>
                <p class="text-[12px]">Quantity: {{ item.quantity }}</p>
                <p class="text-[12px]">Total: {{ item.final_line_price | money }}</p>
              </div>

              <button class="h-min w-min text-[12px]" data-line="{{ forloop.index }}">
                {{ 'cart.remove' | t }}
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <button class="mt-[20px] text-left" id="cart-checkout-mobile">
        <p class="pb-[10px] text-[12px] font-medium">Total: {{ cart.total_price | money }}</p>
        <p class="text-[12px] font-medium">Proceed to Checkout</p>
      </button>
    {% else %}
      <div class="py-[40px] text-center">
        <p class="text-[12px]">{{ 'cart.empty' | t | default: 'Your cart is empty' }}</p>
      </div>
    {% endif %}
  </div>

</div>

{% stylesheet %}
  #cart-drawer-overlay.is-open {
    display: flex !important;
  }

  #cart-drawer-overlay > div {
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  #cart-drawer-overlay.is-open > div {
    transform: translateX(0);
  }
{% endstylesheet %}

<script>
  (function() {
    const overlay = document.getElementById('cart-drawer-overlay');
    if (!overlay) return;

    const closeDesktop = document.getElementById('cart-drawer-close-desktop');
    const closeMobile = document.getElementById('cart-drawer-close-mobile');
    const checkoutDesktop = document.getElementById('cart-checkout-desktop');
    const checkoutMobile = document.getElementById('cart-checkout-mobile');

    // Open cart drawer
    function openCartDrawer() {
      overlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    // Close cart drawer
    function closeCartDrawer() {
      overlay.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    // Auto-open cart drawer after add to cart (from sessionStorage flag)
    if (sessionStorage.getItem('openCartDrawer') === 'true') {
      sessionStorage.removeItem('openCartDrawer');
      openCartDrawer();
    }

    // Listen for cart trigger clicks (event delegation)
    document.addEventListener('click', function(e) {
      if (e.target.closest('[data-cart-trigger]')) {
        e.preventDefault();
        openCartDrawer();
      }
    });

    // Close buttons
    if (closeDesktop) {
      closeDesktop.addEventListener('click', function(e) {
        e.preventDefault();
        closeCartDrawer();
      });
    }

    if (closeMobile) {
      closeMobile.addEventListener('click', function(e) {
        e.preventDefault();
        closeCartDrawer();
      });
    }

    // Click overlay to close
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeCartDrawer();
      }
    });

    // Escape key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('is-open')) {
        closeCartDrawer();
      }
    });

    // Checkout buttons
    if (checkoutDesktop) {
      checkoutDesktop.addEventListener('click', function() {
        window.location.href = '/checkout';
      });
    }

    if (checkoutMobile) {
      checkoutMobile.addEventListener('click', function() {
        window.location.href = '/checkout';
      });
    }

    // Remove item buttons
    const removeButtons = document.querySelectorAll('[data-line]');
    removeButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        const line = this.getAttribute('data-line');
        if (line) {
          fetch('/cart/change.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              line: line,
              quantity: 0
            })
          })
          .then(function(response) {
            return response.json();
          })
          .then(function() {
            window.location.reload();
          })
          .catch(function(error) {
            console.error('Error removing item:', error);
          });
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Cart Drawer",
  "settings": []
}
{% endschema %}
